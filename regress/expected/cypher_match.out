/*
 * Copyright (C) 2023-2024 PostGraphDB
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *
 * Portions Copyright (c) 2020-2023, Apache Software Foundation
 * Portions Copyright (c) 2019-2020, Bitnine Global
 */ 
LOAD 'postgraph';
CREATE GRAPH cypher_match;
NOTICE:  graph "cypher_match" has been created
 create_graph 
--------------
 
(1 row)

USE GRAPH cypher_match;
 use_graph 
-----------
 
(1 row)

CREATE (:v);
--
(0 rows)

CREATE (:v {i: 0});
--
(0 rows)

CREATE (:v {i: 1});
--
(0 rows)

MATCH (n:v) RETURN n;
                               n                               
---------------------------------------------------------------
 {"id": 844424930131969, "label": "v", "properties": {}}
 {"id": 844424930131970, "label": "v", "properties": {"i": 0}}
 {"id": 844424930131971, "label": "v", "properties": {"i": 1}}
(3 rows)

MATCH (n:v) RETURN n.i;
 i 
---
 
 0
 1
(3 rows)

MATCH (n:v) WHERE n.i > 0
RETURN n.i;
 i 
---
 1
(1 row)

--Directed Paths
CREATE (:v1 {id:'initial'})-[:e1]->(:v1 {id:'middle'})-[:e1]->(:v1 {id:'end'});
--
(0 rows)

--Undirected Path Tests
MATCH p=(:v1)-[:e1]-(:v1)-[:e1]-(:v1) RETURN p;
                                                                                                                                                                                                                                  p                                                                                                                                                                                                                                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 [{"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}, {"id": 1407374883553282, "start_id": 1125899906842625, "end_id": 1125899906842626, "label": "e1", "properties": {}}, {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}, {"id": 1407374883553281, "start_id": 1125899906842626, "end_id": 1125899906842627, "label": "e1", "properties": {}}, {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}]
 [{"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}, {"id": 1407374883553281, "start_id": 1125899906842626, "end_id": 1125899906842627, "label": "e1", "properties": {}}, {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}, {"id": 1407374883553282, "start_id": 1125899906842625, "end_id": 1125899906842626, "label": "e1", "properties": {}}, {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}]
(2 rows)

MATCH p=(a:v1)-[]-()-[]-() RETURN a;
                                    a                                     
--------------------------------------------------------------------------
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}
 {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}
(2 rows)

MATCH ()-[]-()-[]-(a:v1) RETURN a;
                                    a                                     
--------------------------------------------------------------------------
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}
 {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}
(2 rows)

MATCH ()-[]-(a:v1)-[]-() RETURN a;
                                    a                                    
-------------------------------------------------------------------------
 {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}
 {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}
(2 rows)

MATCH ()-[b:e1]-()-[]-() RETURN b;
                                                          b                                                          
---------------------------------------------------------------------------------------------------------------------
 {"id": 1407374883553282, "start_id": 1125899906842625, "end_id": 1125899906842626, "label": "e1", "properties": {}}
 {"id": 1407374883553281, "start_id": 1125899906842626, "end_id": 1125899906842627, "label": "e1", "properties": {}}
(2 rows)

MATCH (a:v1)-[]->(), ()-[]->(a) RETURN a;
                                    a                                    
-------------------------------------------------------------------------
 {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}
(1 row)

MATCH p=()-[e]-() RETURN e;
                                                          e                                                          
---------------------------------------------------------------------------------------------------------------------
 {"id": 1407374883553281, "start_id": 1125899906842626, "end_id": 1125899906842627, "label": "e1", "properties": {}}
 {"id": 1407374883553281, "start_id": 1125899906842626, "end_id": 1125899906842627, "label": "e1", "properties": {}}
 {"id": 1407374883553282, "start_id": 1125899906842625, "end_id": 1125899906842626, "label": "e1", "properties": {}}
 {"id": 1407374883553282, "start_id": 1125899906842625, "end_id": 1125899906842626, "label": "e1", "properties": {}}
(4 rows)

-- Right Path Test
MATCH (a:v1)-[:e1]->(b:v1)-[:e1]->(c:v1) RETURN a, b, c;
                                    a                                     |                                    b                                    |                                  c                                   
--------------------------------------------------------------------------+-------------------------------------------------------------------------+----------------------------------------------------------------------
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}} | {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}} | {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}
(1 row)

MATCH p=(a:v1)-[]-()-[]->() RETURN a;
                                    a                                     
--------------------------------------------------------------------------
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}
(1 row)

MATCH p=(a:v1)-[]->()-[]-() RETURN a;
                                    a                                     
--------------------------------------------------------------------------
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}
(1 row)

MATCH ()-[]-()-[]->(a:v1) RETURN a;
                                  a                                   
----------------------------------------------------------------------
 {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}
(1 row)

MATCH ()-[]-(a:v1)-[]->() RETURN a;
                                    a                                    
-------------------------------------------------------------------------
 {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}
(1 row)

MATCH ()-[b:e1]-()-[]->() RETURN b;
                                                          b                                                          
---------------------------------------------------------------------------------------------------------------------
 {"id": 1407374883553282, "start_id": 1125899906842625, "end_id": 1125899906842626, "label": "e1", "properties": {}}
(1 row)

--Left Path Test
MATCH (a:v1)<-[:e1]-(b:v1)<-[:e1]-(c:v1) RETURN a, b, c;
                                  a                                   |                                    b                                    |                                    c                                     
----------------------------------------------------------------------+-------------------------------------------------------------------------+--------------------------------------------------------------------------
 {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}} | {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}} | {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}
(1 row)

MATCH p=(a:v1)<-[]-()-[]-() RETURN a;
                                  a                                   
----------------------------------------------------------------------
 {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}
(1 row)

MATCH p=(a:v1)-[]-()<-[]-() RETURN a;
                                  a                                   
----------------------------------------------------------------------
 {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}
(1 row)

MATCH ()<-[]-()-[]-(a:v1) RETURN a;
                                    a                                     
--------------------------------------------------------------------------
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}
(1 row)

MATCH ()<-[]-(a:v1)-[]-() RETURN a;
                                    a                                    
-------------------------------------------------------------------------
 {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}
(1 row)

MATCH ()<-[b:e1]-()-[]-() RETURN b;
                                                          b                                                          
---------------------------------------------------------------------------------------------------------------------
 {"id": 1407374883553281, "start_id": 1125899906842626, "end_id": 1125899906842627, "label": "e1", "properties": {}}
(1 row)

--Divergent Path Tests
CREATE (:v2 {id:'initial'})<-[:e2]-(:v2 {id:'middle'})-[:e2]->(:v2 {id:'end'});
--
(0 rows)

MATCH ()<-[]-(n:v2)-[]->() MATCH p=()-[]->(n) RETURN p;
 p 
---
(0 rows)

MATCH ()<-[]-(n:v2)-[]->() MATCH p=(n)-[]->() RETURN p;
                                                                                                                                    p                                                                                                                                     
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 [{"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}, {"id": 1970324836974593, "start_id": 1688849860263938, "end_id": 1688849860263939, "label": "e2", "properties": {}}, {"id": 1688849860263939, "label": "v2", "properties": {"id": "end"}}]
 [{"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}, {"id": 1970324836974593, "start_id": 1688849860263938, "end_id": 1688849860263939, "label": "e2", "properties": {}}, {"id": 1688849860263939, "label": "v2", "properties": {"id": "end"}}]
 [{"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}, {"id": 1970324836974594, "start_id": 1688849860263938, "end_id": 1688849860263937, "label": "e2", "properties": {}}, {"id": 1688849860263937, "label": "v2", "properties": {"id": "initial"}}]
 [{"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}, {"id": 1970324836974594, "start_id": 1688849860263938, "end_id": 1688849860263937, "label": "e2", "properties": {}}, {"id": 1688849860263937, "label": "v2", "properties": {"id": "initial"}}]
(4 rows)

MATCH ()-[]-(n:v2) RETURN n;
                                    n                                     
--------------------------------------------------------------------------
 {"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}
 {"id": 1688849860263939, "label": "v2", "properties": {"id": "end"}}
 {"id": 1688849860263937, "label": "v2", "properties": {"id": "initial"}}
 {"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}
(4 rows)

--Convergent Path Tests
CREATE (:v3 {id:'initial'})-[:e3]->(:v3 {id:'middle'})<-[:e3]-(:v3 {id:'end'});
--
(0 rows)

MATCH ()-[b:e1]->() RETURN b;
                                                          b                                                          
---------------------------------------------------------------------------------------------------------------------
 {"id": 1407374883553281, "start_id": 1125899906842626, "end_id": 1125899906842627, "label": "e1", "properties": {}}
 {"id": 1407374883553282, "start_id": 1125899906842625, "end_id": 1125899906842626, "label": "e1", "properties": {}}
(2 rows)

MATCH ()-[]->(n:v1)<-[]-() MATCH p=(n)<-[]-() RETURN p;
 p 
---
(0 rows)

MATCH ()-[]->(n:v1)<-[]-() MATCH p=()-[]->(n) RETURN p;
 p 
---
(0 rows)

MATCH ()-[]->(n:v1)<-[]-() MATCH p=(n)-[]->() RETURN p;
 p 
---
(0 rows)

MATCH con_path=(a)-[]->()<-[]-() WHERE a.id = 'initial' RETURN con_path;
                                                                                                                                                                                                                              con_path                                                                                                                                                                                                                               
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 [{"id": 2251799813685249, "label": "v3", "properties": {"id": "initial"}}, {"id": 2533274790395906, "start_id": 2251799813685249, "end_id": 2251799813685250, "label": "e3", "properties": {}}, {"id": 2251799813685250, "label": "v3", "properties": {"id": "middle"}}, {"id": 2533274790395905, "start_id": 2251799813685251, "end_id": 2251799813685250, "label": "e3", "properties": {}}, {"id": 2251799813685251, "label": "v3", "properties": {"id": "end"}}]
(1 row)

MATCH div_path=(b)<-[]-()-[]->() WHERE b.id = 'initial' RETURN div_path;
                                                                                                                                                                                                                              div_path                                                                                                                                                                                                                               
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 [{"id": 1688849860263937, "label": "v2", "properties": {"id": "initial"}}, {"id": 1970324836974594, "start_id": 1688849860263938, "end_id": 1688849860263937, "label": "e2", "properties": {}}, {"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}, {"id": 1970324836974593, "start_id": 1688849860263938, "end_id": 1688849860263939, "label": "e2", "properties": {}}, {"id": 1688849860263939, "label": "v2", "properties": {"id": "end"}}]
(1 row)

--Patterns
MATCH (a:v1), p=(a)-[]-()-[]-() WHERE a.id = 'initial' RETURN p;
                                                                                                                                                                                                                                  p                                                                                                                                                                                                                                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 [{"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}, {"id": 1407374883553282, "start_id": 1125899906842625, "end_id": 1125899906842626, "label": "e1", "properties": {}}, {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}, {"id": 1407374883553281, "start_id": 1125899906842626, "end_id": 1125899906842627, "label": "e1", "properties": {}}, {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}]
(1 row)

MATCH con_path=(a)-[]->()<-[]-(), div_path=(b)<-[]-()-[]->() WHERE a.id = 'initial' AND b.id = 'initial' RETURN con_path, div_path;
                                                                                                                                                                                                                              con_path                                                                                                                                                                                                                               |                                                                                                                                                                                                                              div_path                                                                                                                                                                                                                               
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 [{"id": 2251799813685249, "label": "v3", "properties": {"id": "initial"}}, {"id": 2533274790395906, "start_id": 2251799813685249, "end_id": 2251799813685250, "label": "e3", "properties": {}}, {"id": 2251799813685250, "label": "v3", "properties": {"id": "middle"}}, {"id": 2533274790395905, "start_id": 2251799813685251, "end_id": 2251799813685250, "label": "e3", "properties": {}}, {"id": 2251799813685251, "label": "v3", "properties": {"id": "end"}}] | [{"id": 1688849860263937, "label": "v2", "properties": {"id": "initial"}}, {"id": 1970324836974594, "start_id": 1688849860263938, "end_id": 1688849860263937, "label": "e2", "properties": {}}, {"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}, {"id": 1970324836974593, "start_id": 1688849860263938, "end_id": 1688849860263939, "label": "e2", "properties": {}}, {"id": 1688849860263939, "label": "v2", "properties": {"id": "end"}}]
(1 row)

MATCH (a:v), p=()-[]->()-[]->() RETURN a.i, p;
 i |                                                                                                                                                                                                                                  p                                                                                                                                                                                                                                  
---+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1 | [{"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}, {"id": 1407374883553282, "start_id": 1125899906842625, "end_id": 1125899906842626, "label": "e1", "properties": {}}, {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}, {"id": 1407374883553281, "start_id": 1125899906842626, "end_id": 1125899906842627, "label": "e1", "properties": {}}, {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}]
 0 | [{"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}, {"id": 1407374883553282, "start_id": 1125899906842625, "end_id": 1125899906842626, "label": "e1", "properties": {}}, {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}, {"id": 1407374883553281, "start_id": 1125899906842626, "end_id": 1125899906842627, "label": "e1", "properties": {}}, {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}]
   | [{"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}, {"id": 1407374883553282, "start_id": 1125899906842625, "end_id": 1125899906842626, "label": "e1", "properties": {}}, {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}, {"id": 1407374883553281, "start_id": 1125899906842626, "end_id": 1125899906842627, "label": "e1", "properties": {}}, {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}]
(3 rows)

--Multiple Match Clauses
MATCH (a:v1) WHERE a.id = 'initial' MATCH p=(a)-[]-()-[]-() RETURN p;
                                                                                                                                                                                                                                  p                                                                                                                                                                                                                                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 [{"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}, {"id": 1407374883553282, "start_id": 1125899906842625, "end_id": 1125899906842626, "label": "e1", "properties": {}}, {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}, {"id": 1407374883553281, "start_id": 1125899906842626, "end_id": 1125899906842627, "label": "e1", "properties": {}}, {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}]
(1 row)

MATCH (a:v) MATCH p=()-[]->()-[]->() RETURN a.i, p;
 i |                                                                                                                                                                                                                                  p                                                                                                                                                                                                                                  
---+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1 | [{"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}, {"id": 1407374883553282, "start_id": 1125899906842625, "end_id": 1125899906842626, "label": "e1", "properties": {}}, {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}, {"id": 1407374883553281, "start_id": 1125899906842626, "end_id": 1125899906842627, "label": "e1", "properties": {}}, {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}]
 0 | [{"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}, {"id": 1407374883553282, "start_id": 1125899906842625, "end_id": 1125899906842626, "label": "e1", "properties": {}}, {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}, {"id": 1407374883553281, "start_id": 1125899906842626, "end_id": 1125899906842627, "label": "e1", "properties": {}}, {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}]
   | [{"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}, {"id": 1407374883553282, "start_id": 1125899906842625, "end_id": 1125899906842626, "label": "e1", "properties": {}}, {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}, {"id": 1407374883553281, "start_id": 1125899906842626, "end_id": 1125899906842627, "label": "e1", "properties": {}}, {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}]
(3 rows)

MATCH (a:v) MATCH (b:v1)-[]-(c) RETURN a.i, b.id, c.id;
 i |    id     |    id     
---+-----------+-----------
   | "end"     | "middle"
 0 | "end"     | "middle"
 1 | "end"     | "middle"
   | "middle"  | "end"
 0 | "middle"  | "end"
 1 | "middle"  | "end"
   | "middle"  | "initial"
 0 | "middle"  | "initial"
 1 | "middle"  | "initial"
   | "initial" | "middle"
 0 | "initial" | "middle"
 1 | "initial" | "middle"
(12 rows)

--
-- Property constraints
--
CREATE ({string_key: 'test', int_key: 1, float_key: 3.14, map_key: {key: 'value'}, list_key: [1, 2, 3]});
--
(0 rows)

CREATE ({lst: [1, NULL, 3.14, 'string', {key: 'value'}, []]});
--
(0 rows)

MATCH (n  {string_key: NULL}) RETURN n;
 n 
---
(0 rows)

MATCH (n  {string_key: 'wrong value'}) RETURN n ;
 n 
---
(0 rows)

MATCH (n {string_key: 'test', int_key: 1, float_key: 3.14, map_key: {key: 'value'}, list_key: [1, 2, 3]}) RETURN n;
                                                                                n                                                                                
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"id": 281474976710657, "label": "", "properties": {"int_key": 1, "map_key": {"key": "value"}, "list_key": [1, 2, 3], "float_key": 3.14, "string_key": "test"}}
(1 row)

MATCH (n {string_key: 'test'}) RETURN n;
                                                                                n                                                                                
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"id": 281474976710657, "label": "", "properties": {"int_key": 1, "map_key": {"key": "value"}, "list_key": [1, 2, 3], "float_key": 3.14, "string_key": "test"}}
(1 row)

MATCH (n {lst: [1, NULL, 3.14, 'string', {key: 'value'}, []]}) RETURN n;
                                                      n                                                       
--------------------------------------------------------------------------------------------------------------
 {"id": 281474976710658, "label": "", "properties": {"lst": [1, null, 3.14, "string", {"key": "value"}, []]}}
(1 row)

MATCH (n {lst: [1, NULL, 3.14, 'string', {key: 'value'}, [], 'extra value']})  RETURN n;
 n 
---
(0 rows)

-- Path of one vertex.
MATCH p=() RETURN p;
                                                                                 p                                                                                 
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
 [{"id": 281474976710657, "label": "", "properties": {"int_key": 1, "map_key": {"key": "value"}, "list_key": [1, 2, 3], "float_key": 3.14, "string_key": "test"}}]
 [{"id": 281474976710658, "label": "", "properties": {"lst": [1, null, 3.14, "string", {"key": "value"}, []]}}]
 [{"id": 2251799813685249, "label": "v3", "properties": {"id": "initial"}}]
 [{"id": 2251799813685250, "label": "v3", "properties": {"id": "middle"}}]
 [{"id": 2251799813685251, "label": "v3", "properties": {"id": "end"}}]
 [{"id": 1688849860263937, "label": "v2", "properties": {"id": "initial"}}]
 [{"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}]
 [{"id": 1688849860263939, "label": "v2", "properties": {"id": "end"}}]
 [{"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}]
 [{"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}]
 [{"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}]
 [{"id": 844424930131969, "label": "v", "properties": {}}]
 [{"id": 844424930131970, "label": "v", "properties": {"i": 0}}]
 [{"id": 844424930131971, "label": "v", "properties": {"i": 1}}]
(14 rows)

--
-- MATCH with WHERE EXISTS(pattern)
--
MATCH (u)-[e]->(v) RETURN u, e, v ;
                                    u                                     |                                                          e                                                          |                                    v                                     
--------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------
 {"id": 2251799813685249, "label": "v3", "properties": {"id": "initial"}} | {"id": 2533274790395906, "start_id": 2251799813685249, "end_id": 2251799813685250, "label": "e3", "properties": {}} | {"id": 2251799813685250, "label": "v3", "properties": {"id": "middle"}}
 {"id": 2251799813685251, "label": "v3", "properties": {"id": "end"}}     | {"id": 2533274790395905, "start_id": 2251799813685251, "end_id": 2251799813685250, "label": "e3", "properties": {}} | {"id": 2251799813685250, "label": "v3", "properties": {"id": "middle"}}
 {"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}  | {"id": 1970324836974594, "start_id": 1688849860263938, "end_id": 1688849860263937, "label": "e2", "properties": {}} | {"id": 1688849860263937, "label": "v2", "properties": {"id": "initial"}}
 {"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}  | {"id": 1970324836974593, "start_id": 1688849860263938, "end_id": 1688849860263939, "label": "e2", "properties": {}} | {"id": 1688849860263939, "label": "v2", "properties": {"id": "end"}}
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}} | {"id": 1407374883553282, "start_id": 1125899906842625, "end_id": 1125899906842626, "label": "e1", "properties": {}} | {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}
 {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}  | {"id": 1407374883553281, "start_id": 1125899906842626, "end_id": 1125899906842627, "label": "e1", "properties": {}} | {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}
(6 rows)

MATCH (u)-[e]->(v) WHERE EXISTS ((u)-[e]->(v)) RETURN u, e, v;
                                    u                                     |                                                          e                                                          |                                    v                                     
--------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------
 {"id": 2251799813685249, "label": "v3", "properties": {"id": "initial"}} | {"id": 2533274790395906, "start_id": 2251799813685249, "end_id": 2251799813685250, "label": "e3", "properties": {}} | {"id": 2251799813685250, "label": "v3", "properties": {"id": "middle"}}
 {"id": 2251799813685251, "label": "v3", "properties": {"id": "end"}}     | {"id": 2533274790395905, "start_id": 2251799813685251, "end_id": 2251799813685250, "label": "e3", "properties": {}} | {"id": 2251799813685250, "label": "v3", "properties": {"id": "middle"}}
 {"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}  | {"id": 1970324836974594, "start_id": 1688849860263938, "end_id": 1688849860263937, "label": "e2", "properties": {}} | {"id": 1688849860263937, "label": "v2", "properties": {"id": "initial"}}
 {"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}  | {"id": 1970324836974593, "start_id": 1688849860263938, "end_id": 1688849860263939, "label": "e2", "properties": {}} | {"id": 1688849860263939, "label": "v2", "properties": {"id": "end"}}
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}} | {"id": 1407374883553282, "start_id": 1125899906842625, "end_id": 1125899906842626, "label": "e1", "properties": {}} | {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}
 {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}  | {"id": 1407374883553281, "start_id": 1125899906842626, "end_id": 1125899906842627, "label": "e1", "properties": {}} | {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}
(6 rows)

-- Property Constraint in EXISTS
MATCH (u) WHERE EXISTS((u)-[]->({id: 'middle'})) RETURN u;
                                    u                                     
--------------------------------------------------------------------------
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}
 {"id": 2251799813685249, "label": "v3", "properties": {"id": "initial"}}
 {"id": 2251799813685251, "label": "v3", "properties": {"id": "end"}}
(3 rows)

MATCH (u) WHERE EXISTS((u)-[]->({id: 'not a valid id'})) RETURN u;
 u 
---
(0 rows)

MATCH (u) WHERE EXISTS((u)-[]->({id: NULL})) RETURN u;
 u 
---
(0 rows)

-- Exists checks for a loop. There shouldn't be any.
MATCH (u)-[e]->(v) WHERE EXISTS((u)-[e]->(u)) RETURN u, e, v;
 u | e | v 
---+---+---
(0 rows)

-- Querying NOT EXISTS syntax
-- Create a loop
CREATE (u:loop {id:'initial'})-[:self]->(u);
--
(0 rows)

-- dump paths
MATCH (u)-[e]->(v) WHERE EXISTS((u)-[e]->(v)) RETURN u, e, v;
                                     u                                      |                                                           e                                                           |                                     v                                      
----------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------
 {"id": 2814749767106561, "label": "loop", "properties": {"id": "initial"}} | {"id": 3096224743817217, "start_id": 2814749767106561, "end_id": 2814749767106561, "label": "self", "properties": {}} | {"id": 2814749767106561, "label": "loop", "properties": {"id": "initial"}}
 {"id": 2251799813685249, "label": "v3", "properties": {"id": "initial"}}   | {"id": 2533274790395906, "start_id": 2251799813685249, "end_id": 2251799813685250, "label": "e3", "properties": {}}   | {"id": 2251799813685250, "label": "v3", "properties": {"id": "middle"}}
 {"id": 2251799813685251, "label": "v3", "properties": {"id": "end"}}       | {"id": 2533274790395905, "start_id": 2251799813685251, "end_id": 2251799813685250, "label": "e3", "properties": {}}   | {"id": 2251799813685250, "label": "v3", "properties": {"id": "middle"}}
 {"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}    | {"id": 1970324836974594, "start_id": 1688849860263938, "end_id": 1688849860263937, "label": "e2", "properties": {}}   | {"id": 1688849860263937, "label": "v2", "properties": {"id": "initial"}}
 {"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}    | {"id": 1970324836974593, "start_id": 1688849860263938, "end_id": 1688849860263939, "label": "e2", "properties": {}}   | {"id": 1688849860263939, "label": "v2", "properties": {"id": "end"}}
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}   | {"id": 1407374883553282, "start_id": 1125899906842625, "end_id": 1125899906842626, "label": "e1", "properties": {}}   | {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}
 {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}    | {"id": 1407374883553281, "start_id": 1125899906842626, "end_id": 1125899906842627, "label": "e1", "properties": {}}   | {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}
(7 rows)

-- Exists checks for a loop. There should be one.
MATCH (u)-[e]->(v) WHERE EXISTS((u)-[e]->(u)) RETURN u, e, v;
                                     u                                      |                                                           e                                                           |                                     v                                      
----------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------
 {"id": 2814749767106561, "label": "loop", "properties": {"id": "initial"}} | {"id": 3096224743817217, "start_id": 2814749767106561, "end_id": 2814749767106561, "label": "self", "properties": {}} | {"id": 2814749767106561, "label": "loop", "properties": {"id": "initial"}}
(1 row)

-- Exists checks for a loop. There should be one.
MATCH (u)-[e]->(v) WHERE EXISTS((v)-[e]->(v)) RETURN u, e, v;
                                     u                                      |                                                           e                                                           |                                     v                                      
----------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------
 {"id": 2814749767106561, "label": "loop", "properties": {"id": "initial"}} | {"id": 3096224743817217, "start_id": 2814749767106561, "end_id": 2814749767106561, "label": "self", "properties": {}} | {"id": 2814749767106561, "label": "loop", "properties": {"id": "initial"}}
(1 row)

-- Exists checks for a loop. There should be none because of edge uniqueness
-- requirement.
MATCH (u)-[e]->(v) WHERE EXISTS((u)-[e]->(u)-[e]->(u)) RETURN u, e, v;
 u | e | v 
---+---+---
(0 rows)

MATCH (u)-[e]->(v) WHERE EXISTS((u)-[e]->(u)) AND EXISTS((v)-[e]->(v)) RETURN u, e, v;
                                     u                                      |                                                           e                                                           |                                     v                                      
----------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------
 {"id": 2814749767106561, "label": "loop", "properties": {"id": "initial"}} | {"id": 3096224743817217, "start_id": 2814749767106561, "end_id": 2814749767106561, "label": "self", "properties": {}} | {"id": 2814749767106561, "label": "loop", "properties": {"id": "initial"}}
(1 row)

MATCH (u)-[e]->(v) WHERE EXISTS((u)-[e]->(x)) RETURN u, e, v;
                                     u                                      |                                                           e                                                           |                                     v                                      
----------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------
 {"id": 2814749767106561, "label": "loop", "properties": {"id": "initial"}} | {"id": 3096224743817217, "start_id": 2814749767106561, "end_id": 2814749767106561, "label": "self", "properties": {}} | {"id": 2814749767106561, "label": "loop", "properties": {"id": "initial"}}
 {"id": 2251799813685249, "label": "v3", "properties": {"id": "initial"}}   | {"id": 2533274790395906, "start_id": 2251799813685249, "end_id": 2251799813685250, "label": "e3", "properties": {}}   | {"id": 2251799813685250, "label": "v3", "properties": {"id": "middle"}}
 {"id": 2251799813685251, "label": "v3", "properties": {"id": "end"}}       | {"id": 2533274790395905, "start_id": 2251799813685251, "end_id": 2251799813685250, "label": "e3", "properties": {}}   | {"id": 2251799813685250, "label": "v3", "properties": {"id": "middle"}}
 {"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}    | {"id": 1970324836974594, "start_id": 1688849860263938, "end_id": 1688849860263937, "label": "e2", "properties": {}}   | {"id": 1688849860263937, "label": "v2", "properties": {"id": "initial"}}
 {"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}    | {"id": 1970324836974593, "start_id": 1688849860263938, "end_id": 1688849860263939, "label": "e2", "properties": {}}   | {"id": 1688849860263939, "label": "v2", "properties": {"id": "end"}}
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}   | {"id": 1407374883553282, "start_id": 1125899906842625, "end_id": 1125899906842626, "label": "e1", "properties": {}}   | {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}
 {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}    | {"id": 1407374883553281, "start_id": 1125899906842626, "end_id": 1125899906842627, "label": "e1", "properties": {}}   | {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}
(7 rows)

MATCH (u) WHERE EXISTS(MATCH (u)-[]->({id: 'middle'}) RETURN 1) RETURN u;
                                    u                                     
--------------------------------------------------------------------------
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}
 {"id": 2251799813685249, "label": "v3", "properties": {"id": "initial"}}
 {"id": 2251799813685251, "label": "v3", "properties": {"id": "end"}}
(3 rows)

MATCH (u) WHERE EXISTS(MATCH (u)-[]->({id: 'middle'}) RETURN u) RETURN u;
                                    u                                     
--------------------------------------------------------------------------
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}
 {"id": 2251799813685249, "label": "v3", "properties": {"id": "initial"}}
 {"id": 2251799813685251, "label": "v3", "properties": {"id": "end"}}
(3 rows)

MATCH (u) WHERE u.id = ANY (MATCH (v) RETURN v.id) RETURN u;
                                     u                                      
----------------------------------------------------------------------------
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}
 {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}
 {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}
 {"id": 1688849860263937, "label": "v2", "properties": {"id": "initial"}}
 {"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}
 {"id": 1688849860263939, "label": "v2", "properties": {"id": "end"}}
 {"id": 2251799813685249, "label": "v3", "properties": {"id": "initial"}}
 {"id": 2251799813685250, "label": "v3", "properties": {"id": "middle"}}
 {"id": 2251799813685251, "label": "v3", "properties": {"id": "end"}}
 {"id": 2814749767106561, "label": "loop", "properties": {"id": "initial"}}
(10 rows)

MATCH (u) WHERE u.id = ANY (MATCH (v) RETURN NULL) RETURN u;
 u 
---
(0 rows)

MATCH (u) WHERE u.id = SOME (MATCH (v) RETURN v.id) RETURN u;
                                     u                                      
----------------------------------------------------------------------------
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}
 {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}
 {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}
 {"id": 1688849860263937, "label": "v2", "properties": {"id": "initial"}}
 {"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}
 {"id": 1688849860263939, "label": "v2", "properties": {"id": "end"}}
 {"id": 2251799813685249, "label": "v3", "properties": {"id": "initial"}}
 {"id": 2251799813685250, "label": "v3", "properties": {"id": "middle"}}
 {"id": 2251799813685251, "label": "v3", "properties": {"id": "end"}}
 {"id": 2814749767106561, "label": "loop", "properties": {"id": "initial"}}
(10 rows)

MATCH (u) WHERE u.id = ALL (MATCH (v) RETURN v.id) RETURN u;
 u 
---
(0 rows)

MATCH (u)
WHERE EXISTS( MATCH (u)-[]->(v) WHERE v.id = 'middle' RETURN 1)
RETURN u;
                                    u                                     
--------------------------------------------------------------------------
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}
 {"id": 2251799813685249, "label": "v3", "properties": {"id": "initial"}}
 {"id": 2251799813685251, "label": "v3", "properties": {"id": "end"}}
(3 rows)

MATCH (u) WHERE EXISTS(MATCH (u)-[]->({id: 'gsjka'}) RETURN 1) RETURN u;
 u 
---
(0 rows)

MATCH (u) WHERE EXISTS(MATCH (v {id: 'middle'}) MATCH (u)-[]->(v) RETURN 1) RETURN u;
                                    u                                     
--------------------------------------------------------------------------
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}
 {"id": 2251799813685249, "label": "v3", "properties": {"id": "initial"}}
 {"id": 2251799813685251, "label": "v3", "properties": {"id": "end"}}
(3 rows)

MATCH (u) WHERE EXISTS(MATCH (v {id: 'middle'}) MATCH (u)-[]->(v) RETURN 1) RETURN u;
                                    u                                     
--------------------------------------------------------------------------
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}
 {"id": 2251799813685249, "label": "v3", "properties": {"id": "initial"}}
 {"id": 2251799813685251, "label": "v3", "properties": {"id": "end"}}
(3 rows)

MATCH (u) WHERE EXISTS(MATCH (u)-[]->(v {id: 'middle'}) RETURN 1) RETURN u;
                                    u                                     
--------------------------------------------------------------------------
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}
 {"id": 2251799813685249, "label": "v3", "properties": {"id": "initial"}}
 {"id": 2251799813685251, "label": "v3", "properties": {"id": "end"}}
(3 rows)

MATCH (u) RETURN case WHEN EXISTS(MATCH (u)-[]->({id: 'gsjka'}) RETURN 1) THEN 1 ELSE 2 END;
 case 
------
 2
 2
 2
 2
 2
 2
 2
 2
 2
 2
 2
 2
 2
 2
 2
(15 rows)

MATCH (u) RETURN case WHEN EXISTS(MATCH (u)-[]->() RETURN 1) THEN 1 ELSE 2 END;
 case 
------
 2
 2
 2
 2
 2
 1
 1
 2
 2
 1
 2
 1
 2
 1
 1
(15 rows)

 
MATCH (u) RETURN case WHEN EXISTS(MATCH (u)-[]->() RETURN 1) THEN 1 ELSE 2 END;
 case 
------
 2
 2
 2
 2
 2
 1
 1
 2
 2
 1
 2
 1
 2
 1
 1
(15 rows)

MATCH (u) RETURN case WHEN EXISTS((u)-[]->()) THEN 1 ELSE 2 END;
 case 
------
 2
 2
 2
 2
 2
 1
 1
 2
 2
 1
 2
 1
 2
 1
 1
(15 rows)

/*
EXPLAIN
SELECT *
FROM cypher_match._ag_label_vertex as u
WHERE EXISTS (
SELECT * FROM cypher_match._ag_label_edge as e 
JOIN cypher_match._ag_label_vertex as v ON v.id = e.end_id
WHERE u.id = e.start_id
);
*/
--
--Distinct
--
MATCH (u) RETURN DISTINCT props(u);
ERROR:  function postgraph.props(postgraph.vertex) does not exist
LINE 14: MATCH (u) RETURN DISTINCT props(u);
                                   ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
CREATE (u:duplicate)-[:dup_edge {id:1 }]->(:other_v);
--
(0 rows)

MATCH (u:duplicate) CREATE (u)-[:dup_edge {id:2 }]->(:other_v);
--
(0 rows)

MATCH (u:duplicate)-[]-(:other_v) RETURN DISTINCT u;
ERROR:  operator does not exist: postgraph.label_id postgraph.= integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
MATCH p=(:duplicate)-[]-(:other_v) RETURN DISTINCT p;
                                                                                                                                  p                                                                                                                                   
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 [{"id": 3377699720527873, "label": "duplicate", "properties": {}}, {"id": 3659174697238529, "start_id": 3377699720527873, "end_id": 3940649673949185, "label": "dup_edge", "properties": {"id": 1}}, {"id": 3940649673949185, "label": "other_v", "properties": {}}]
(1 row)

--
-- Limit & Skip
--
MATCH (u) RETURN u;
                                                                                u                                                                                
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"id": 281474976710657, "label": "", "properties": {"int_key": 1, "map_key": {"key": "value"}, "list_key": [1, 2, 3], "float_key": 3.14, "string_key": "test"}}
 {"id": 281474976710658, "label": "", "properties": {"lst": [1, null, 3.14, "string", {"key": "value"}, []]}}
 {"id": 844424930131969, "label": "v", "properties": {}}
 {"id": 844424930131970, "label": "v", "properties": {"i": 0}}
 {"id": 844424930131971, "label": "v", "properties": {"i": 1}}
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}
 {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}
 {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}
 {"id": 1688849860263937, "label": "v2", "properties": {"id": "initial"}}
 {"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}
 {"id": 1688849860263939, "label": "v2", "properties": {"id": "end"}}
 {"id": 2251799813685249, "label": "v3", "properties": {"id": "initial"}}
 {"id": 2251799813685250, "label": "v3", "properties": {"id": "middle"}}
 {"id": 2251799813685251, "label": "v3", "properties": {"id": "end"}}
 {"id": 2814749767106561, "label": "loop", "properties": {"id": "initial"}}
 {"id": 3377699720527873, "label": "duplicate", "properties": {}}
 {"id": 3940649673949185, "label": "other_v", "properties": {}}
 {"id": 3940649673949186, "label": "other_v", "properties": {}}
(18 rows)

MATCH (u) RETURN u LIMIT 3;
ERROR:  syntax error at or near "LIMIT"
LINE 1: MATCH (u) RETURN u LIMIT 3;
                           ^
MATCH (u) RETURN u SKIP 7;
ERROR:  syntax error at or near "SKIP"
LINE 1: MATCH (u) RETURN u SKIP 7;
                           ^
MATCH (u) RETURN u SKIP 7 LIMIT 3;
ERROR:  syntax error at or near "SKIP"
LINE 1: MATCH (u) RETURN u SKIP 7 LIMIT 3;
                           ^
--
-- Optional Match
--
CREATE (:opt_match_v {name: 'someone'})-[:opt_match_e]->(:opt_match_v {name: 'somebody'}),
        (:opt_match_v {name: 'anybody'})-[:opt_match_e]->(:opt_match_v {name: 'nobody'});
--
(0 rows)

MATCH (u:opt_match_v) OPTIONAL MATCH (u)-[m]-(l) RETURN u.name as u, type(m), l.name as l ORDER BY u, m, l;
ERROR:  syntax error at or near "ORDER"
LINE 1: ...-[m]-(l) RETURN u.name as u, type(m), l.name as l ORDER BY u...
                                                             ^
OPTIONAL MATCH (n:opt_match_v)-[r]->(p), (m:opt_match_v)-[s]->(q) WHERE id(n) <> id(m) RETURN n.name as n, type(r); m.name AS m, type(s); ORDER BY n, p, m, q;
     n     |     type      
-----------+---------------
 "someone" | "opt_match_e"
 "anybody" | "opt_match_e"
(2 rows)

ERROR:  syntax error at or near "m"
LINE 1: m.name AS m, type(s);
        ^
ERROR:  syntax error at or near "ORDER"
LINE 1: ORDER BY n, p, m, q;
        ^
MATCH (n:opt_match_v), (m:opt_match_v)
WHERE id(n) <> id(m)
OPTIONAL MATCH (n)-[r]->(p), (m)-[s]->(q)
RETURN n.name AS n, type(r),
           m.name AS m, type(s)
ORDER BY n, p, m, q;
ERROR:  syntax error at or near "ORDER"
LINE 6: ORDER BY n, p, m, q;
        ^
CREATE (u {name: 'orphan'}) CREATE (u1 {name: 'F'})-[u2:e1]->(u3 {name: 'T'}) RETURN u1, u2, u3;
                                u1                                 |                                                        u2                                                         |                                u3                                 
-------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------
 {"id": 281474976710660, "label": "", "properties": {"name": "F"}} | {"id": 1407374883553283, "start_id": 281474976710660, "end_id": 281474976710661, "label": "e1", "properties": {}} | {"id": 281474976710661, "label": "", "properties": {"name": "T"}}
(1 row)

-- Querying NOT EXISTS syntax
MATCH (f),(t) WHERE NOT EXISTS((f)-[]->(t)) RETURN f.name, t.name;
    name    |    name    
------------+------------
            | 
            | 
            | "orphan"
            | "F"
            | "T"
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | "someone"
            | "somebody"
            | "anybody"
            | "nobody"
            | 
            | 
            | "orphan"
            | "F"
            | "T"
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | "someone"
            | "somebody"
            | "anybody"
            | "nobody"
 "orphan"   | 
 "orphan"   | 
 "orphan"   | "orphan"
 "orphan"   | "F"
 "orphan"   | "T"
 "orphan"   | 
 "orphan"   | 
 "orphan"   | 
 "orphan"   | 
 "orphan"   | 
 "orphan"   | 
 "orphan"   | 
 "orphan"   | 
 "orphan"   | 
 "orphan"   | 
 "orphan"   | 
 "orphan"   | 
 "orphan"   | 
 "orphan"   | 
 "orphan"   | 
 "orphan"   | 
 "orphan"   | "someone"
 "orphan"   | "somebody"
 "orphan"   | "anybody"
 "orphan"   | "nobody"
 "F"        | 
 "F"        | 
 "F"        | "orphan"
 "F"        | "F"
 "F"        | 
 "F"        | 
 "F"        | 
 "F"        | 
 "F"        | 
 "F"        | 
 "F"        | 
 "F"        | 
 "F"        | 
 "F"        | 
 "F"        | 
 "F"        | 
 "F"        | 
 "F"        | 
 "F"        | 
 "F"        | 
 "F"        | "someone"
 "F"        | "somebody"
 "F"        | "anybody"
 "F"        | "nobody"
 "T"        | 
 "T"        | 
 "T"        | "orphan"
 "T"        | "F"
 "T"        | "T"
 "T"        | 
 "T"        | 
 "T"        | 
 "T"        | 
 "T"        | 
 "T"        | 
 "T"        | 
 "T"        | 
 "T"        | 
 "T"        | 
 "T"        | 
 "T"        | 
 "T"        | 
 "T"        | 
 "T"        | 
 "T"        | 
 "T"        | "someone"
 "T"        | "somebody"
 "T"        | "anybody"
 "T"        | "nobody"
 "someone"  | 
 "someone"  | 
 "someone"  | "orphan"
 "someone"  | "F"
 "someone"  | "T"
 "someone"  | 
 "someone"  | 
 "someone"  | 
 "someone"  | 
 "someone"  | 
 "someone"  | 
 "someone"  | 
 "someone"  | 
 "someone"  | 
 "someone"  | 
 "someone"  | 
 "someone"  | 
 "someone"  | 
 "someone"  | 
 "someone"  | 
 "someone"  | 
 "someone"  | "someone"
 "someone"  | "anybody"
 "someone"  | "nobody"
 "somebody" | 
 "somebody" | 
 "somebody" | "orphan"
 "somebody" | "F"
 "somebody" | "T"
 "somebody" | 
 "somebody" | 
 "somebody" | 
 "somebody" | 
 "somebody" | 
 "somebody" | 
 "somebody" | 
 "somebody" | 
 "somebody" | 
 "somebody" | 
 "somebody" | 
 "somebody" | 
 "somebody" | 
 "somebody" | 
 "somebody" | 
 "somebody" | 
 "somebody" | "someone"
 "somebody" | "somebody"
 "somebody" | "anybody"
 "somebody" | "nobody"
 "anybody"  | 
 "anybody"  | 
 "anybody"  | "orphan"
 "anybody"  | "F"
 "anybody"  | "T"
 "anybody"  | 
 "anybody"  | 
 "anybody"  | 
 "anybody"  | 
 "anybody"  | 
 "anybody"  | 
 "anybody"  | 
 "anybody"  | 
 "anybody"  | 
 "anybody"  | 
 "anybody"  | 
 "anybody"  | 
 "anybody"  | 
 "anybody"  | 
 "anybody"  | 
 "anybody"  | 
 "anybody"  | "someone"
 "anybody"  | "somebody"
 "anybody"  | "anybody"
 "nobody"   | 
 "nobody"   | 
 "nobody"   | "orphan"
 "nobody"   | "F"
 "nobody"   | "T"
 "nobody"   | 
 "nobody"   | 
 "nobody"   | 
 "nobody"   | 
 "nobody"   | 
 "nobody"   | 
 "nobody"   | 
 "nobody"   | 
 "nobody"   | 
 "nobody"   | 
 "nobody"   | 
 "nobody"   | 
 "nobody"   | 
 "nobody"   | 
 "nobody"   | 
 "nobody"   | 
 "nobody"   | "someone"
 "nobody"   | "somebody"
 "nobody"   | "anybody"
 "nobody"   | "nobody"
            | 
            | 
            | "orphan"
            | "F"
            | "T"
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | "someone"
            | "somebody"
            | "anybody"
            | "nobody"
            | 
            | 
            | "orphan"
            | "F"
            | "T"
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | "someone"
            | "somebody"
            | "anybody"
            | "nobody"
            | 
            | 
            | "orphan"
            | "F"
            | "T"
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | "someone"
            | "somebody"
            | "anybody"
            | "nobody"
            | 
            | 
            | "orphan"
            | "F"
            | "T"
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | "someone"
            | "somebody"
            | "anybody"
            | "nobody"
            | 
            | 
            | "orphan"
            | "F"
            | "T"
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | "someone"
            | "somebody"
            | "anybody"
            | "nobody"
            | 
            | 
            | "orphan"
            | "F"
            | "T"
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | "someone"
            | "somebody"
            | "anybody"
            | "nobody"
            | 
            | 
            | "orphan"
            | "F"
            | "T"
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | "someone"
            | "somebody"
            | "anybody"
            | "nobody"
            | 
            | 
            | "orphan"
            | "F"
            | "T"
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | "someone"
            | "somebody"
            | "anybody"
            | "nobody"
            | 
            | 
            | "orphan"
            | "F"
            | "T"
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | "someone"
            | "somebody"
            | "anybody"
            | "nobody"
            | 
            | 
            | "orphan"
            | "F"
            | "T"
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | "someone"
            | "somebody"
            | "anybody"
            | "nobody"
            | 
            | 
            | "orphan"
            | "F"
            | "T"
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | "someone"
            | "somebody"
            | "anybody"
            | "nobody"
            | 
            | 
            | "orphan"
            | "F"
            | "T"
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | "someone"
            | "somebody"
            | "anybody"
            | "nobody"
            | 
            | 
            | "orphan"
            | "F"
            | "T"
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | "someone"
            | "somebody"
            | "anybody"
            | "nobody"
            | 
            | 
            | "orphan"
            | "F"
            | "T"
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | "someone"
            | "somebody"
            | "anybody"
            | "nobody"
            | 
            | 
            | "orphan"
            | "F"
            | "T"
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | "someone"
            | "somebody"
            | "anybody"
            | "nobody"
            | 
            | 
            | "orphan"
            | "F"
            | "T"
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | 
            | "someone"
            | "somebody"
            | "anybody"
            | "nobody"
(613 rows)

-- Querying EXISTS syntax
MATCH (f),(t) WHERE EXISTS((f)-[]->(t)) RETURN f.name, t.name;
   name    |    name    
-----------+------------
 "F"       | "T"
 "someone" | "somebody"
 "anybody" | "nobody"
           | 
           | 
           | 
           | 
           | 
           | 
           | 
           | 
           | 
(12 rows)

--
-- Constraints and WHERE clause together
--
CREATE ({i: 1, j: 2, k: 3}), ({i: 1, j: 3}), ({i:2, k: 3});
--
(0 rows)

MATCH (n {j: 2}) WHERE n.i = 1 RETURN n;
                                      n                                       
------------------------------------------------------------------------------
 {"id": 281474976710662, "label": "", "properties": {"i": 1, "j": 2, "k": 3}}
(1 row)

--
-- Prepared Statement Property Constraint
--
-- TODO
--
-- Errors
--
-- need a following RETURN clause
MATCH (n:v);
                               n                               |    _id_n___     |  _pr_n   
---------------------------------------------------------------+-----------------+----------
 {"id": 844424930131969, "label": "v", "properties": {}}       | 844424930131969 | {}
 {"id": 844424930131970, "label": "v", "properties": {"i": 0}} | 844424930131970 | {"i": 0}
 {"id": 844424930131971, "label": "v", "properties": {"i": 1}} | 844424930131971 | {"i": 1}
(3 rows)

--Invalid Variables
MATCH (a)-[]-()-[]-(a:v1) RETURN a;
ERROR:  variable a already exists
LINE 1: MATCH (a)-[]-()-[]-(a:v1) RETURN a;
                           ^
MATCH (a:v1)-[]-()-[a]-() RETURN a;
ERROR:  variable a already exists
LINE 1: MATCH (a:v1)-[]-()-[a]-() RETURN a;
                           ^
MATCH (a:v1)-[]-()-[]-(a {id:'will_fail'}) RETURN a;
ERROR:  variable a already exists
LINE 1: MATCH (a:v1)-[]-()-[]-(a {id:'will_fail'}) RETURN a;
                              ^
--Incorrect Labels
MATCH (n)-[:v]-() RETURN n;
ERROR:  label v is for vertices, not edges
LINE 1: MATCH (n)-[:v]-() RETURN n;
                  ^
MATCH (n)-[:emissing]-() RETURN n;
ERROR:  label emissing does not exists
LINE 1: MATCH (n)-[:emissing]-() RETURN n;
                  ^
MATCH (n:e1)-[]-() RETURN n;
ERROR:  label e1 is for edges, not vertices
LINE 1: MATCH (n:e1)-[]-() RETURN n;
              ^
MATCH (n:vmissing)-[]-() RETURN n;
ERROR:  label vmissing does not exists
LINE 1: MATCH (n:vmissing)-[]-() RETURN n;
              ^
CREATE TABLE tst (i int);
INSERT INTO tst VALUES (1), (2), (3);
MATCH (n)
WHERE EXISTS (
        SELECT * FROM tst as t where t.i = n.i
)
RETURN n;
                                      n                                       
------------------------------------------------------------------------------
 {"id": 281474976710662, "label": "", "properties": {"i": 1, "j": 2, "k": 3}}
 {"id": 281474976710663, "label": "", "properties": {"i": 1, "j": 3}}
 {"id": 281474976710664, "label": "", "properties": {"i": 2, "k": 3}}
 {"id": 844424930131971, "label": "v", "properties": {"i": 1}}
(4 rows)

MATCH (n)
WHERE NOT EXISTS (
        SELECT * FROM tst as t where t.i = n.i
)
RETURN n;
                                                                                n                                                                                
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"id": 281474976710657, "label": "", "properties": {"int_key": 1, "map_key": {"key": "value"}, "list_key": [1, 2, 3], "float_key": 3.14, "string_key": "test"}}
 {"id": 281474976710658, "label": "", "properties": {"lst": [1, null, 3.14, "string", {"key": "value"}, []]}}
 {"id": 281474976710659, "label": "", "properties": {"name": "orphan"}}
 {"id": 281474976710660, "label": "", "properties": {"name": "F"}}
 {"id": 281474976710661, "label": "", "properties": {"name": "T"}}
 {"id": 844424930131969, "label": "v", "properties": {}}
 {"id": 844424930131970, "label": "v", "properties": {"i": 0}}
 {"id": 1125899906842625, "label": "v1", "properties": {"id": "initial"}}
 {"id": 1125899906842626, "label": "v1", "properties": {"id": "middle"}}
 {"id": 1125899906842627, "label": "v1", "properties": {"id": "end"}}
 {"id": 1688849860263937, "label": "v2", "properties": {"id": "initial"}}
 {"id": 1688849860263938, "label": "v2", "properties": {"id": "middle"}}
 {"id": 1688849860263939, "label": "v2", "properties": {"id": "end"}}
 {"id": 2251799813685249, "label": "v3", "properties": {"id": "initial"}}
 {"id": 2251799813685250, "label": "v3", "properties": {"id": "middle"}}
 {"id": 2251799813685251, "label": "v3", "properties": {"id": "end"}}
 {"id": 2814749767106561, "label": "loop", "properties": {"id": "initial"}}
 {"id": 3377699720527873, "label": "duplicate", "properties": {}}
 {"id": 3940649673949185, "label": "other_v", "properties": {}}
 {"id": 3940649673949186, "label": "other_v", "properties": {}}
 {"id": 4222124650659841, "label": "opt_match_v", "properties": {"name": "someone"}}
 {"id": 4222124650659842, "label": "opt_match_v", "properties": {"name": "somebody"}}
 {"id": 4222124650659843, "label": "opt_match_v", "properties": {"name": "anybody"}}
 {"id": 4222124650659844, "label": "opt_match_v", "properties": {"name": "nobody"}}
(24 rows)

MATCH (n)
WHERE n.i = ALL (
        SELECT i::postgraph.gtype FROM tst as t
)
RETURN n;
 n 
---
(0 rows)

MATCH (n)
WHERE n.i = ANY (
        SELECT i::postgraph.gtype FROM tst as t
)
RETURN n;
                                      n                                       
------------------------------------------------------------------------------
 {"id": 281474976710662, "label": "", "properties": {"i": 1, "j": 2, "k": 3}}
 {"id": 281474976710663, "label": "", "properties": {"i": 1, "j": 3}}
 {"id": 281474976710664, "label": "", "properties": {"i": 2, "k": 3}}
 {"id": 844424930131971, "label": "v", "properties": {"i": 1}}
(4 rows)

MATCH (n)
WHERE n.i = SOME (
        SELECT i::postgraph.gtype FROM tst as t
)
RETURN n;
                                      n                                       
------------------------------------------------------------------------------
 {"id": 281474976710662, "label": "", "properties": {"i": 1, "j": 2, "k": 3}}
 {"id": 281474976710663, "label": "", "properties": {"i": 1, "j": 3}}
 {"id": 281474976710664, "label": "", "properties": {"i": 2, "k": 3}}
 {"id": 844424930131971, "label": "v", "properties": {"i": 1}}
(4 rows)

SELECT (SELECT * FROM tst);
ERROR:  more than one row returned by a subquery used as an expression
SELECT (SELECT COUNT(*) FROM tst);
 count 
-------
     3
(1 row)

RETURN (SELECT * FROM tst);
ERROR:  more than one row returned by a subquery used as an expression
RETURN (SELECT COUNT(*) FROM tst);
 count 
-------
     3
(1 row)

--
-- Clean up
--
DROP GRAPH cypher_match CASCADE;
NOTICE:  drop cascades to 16 other objects
DETAIL:  drop cascades to table cypher_match._ag_label_vertex
drop cascades to table cypher_match._ag_label_edge
drop cascades to table cypher_match.v
drop cascades to table cypher_match.v1
drop cascades to table cypher_match.e1
drop cascades to table cypher_match.v2
drop cascades to table cypher_match.e2
drop cascades to table cypher_match.v3
drop cascades to table cypher_match.e3
drop cascades to table cypher_match.loop
drop cascades to table cypher_match.self
drop cascades to table cypher_match.duplicate
drop cascades to table cypher_match.dup_edge
drop cascades to table cypher_match.other_v
drop cascades to table cypher_match.opt_match_v
drop cascades to table cypher_match.opt_match_e
NOTICE:  graph "cypher_match" has been dropped
 drop_graph 
------------
 
(1 row)

--
-- End
--
